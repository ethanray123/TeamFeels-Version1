{% extends 'base.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block additionalCss %}
<style type="text/css">
    ul#search_result{
        position: absolute;
        z-index: 1000;
    }
    ul#search_result li{
        padding: 2px 5px 2px 5px;
    }
    ul#search_result span.type{
       color: grey;
       float: right;
       text-transform: uppercase;
    }
</style>
{% endblock additionalCss %}

{% block content %}
	{% if user.is_authenticated %}
	    <blockquote><h1>Hi {{ user.username }}! </h1></blockquote>
   		<input type="text" name="text" id="search" style="width: 500px" autocomplete="off">
    	<button>Search</button>
    	<ul id="search_result" style="background-color: #e4e4e4; width: 500px" class="list-group"></ul>
	    {% if notifications %}
		    <h2>Notifications</h2>
		    <ul id="notif_id" class="collection">
		    {% for notification in notifications %}
		    	<li class="collection-item">{{ notification.display }}</li>
		   	{% endfor %}
		    </ul>
			<a style="font-size: 14px" id="see_more">See More...</a>
		{% endif %}
		<h3>List of Lobbies</h3>
		<ul class="collection">
			{% for lobby in lobbies %}
			<li class="collection-item">
				<br>
				<img class="thumbnail" src="{{lobby.logo.url}}">
				<a href="{% url 'stream:lobby-detail' lobby.id %}"><h3>{{lobby.lobbyname}}</h3></a>
				<p>{{lobby.description}}</p>
			</li>

			{% endfor %}
		</ul>
		<br><br>
	{% else %}
		<h3>You are not logged in...</h3>
    	<a href="{% url 'login' %}" class="btn">login</a>
  	{% endif %}
  	<script>
  		$(function(){
  			// cached the elements
  			var $results_holder = $("#search_result");
  			var $search_bar = $("#search");

  			// clears the ul element with id "search_result" when input element
  			// with id "search" is out of focus
            $(document).click(function(e) {
                if($(e.target).parents('#search_result').length == 0){
                    $('body ul#search_result').empty();
                    $('body input#search').val('');
                }
            });

  			// performs ajax when keyup and focus event happens
	  		$search_bar.on("keyup focus ", function(){
	  			$.ajax({
	  				type: 'GET',
	  				url: 'stream/search_result/',
	  				data: {'search_text': $search_bar.val()},
	  				success: function(results){
                    // appends all the search results in the the ul element
                    // with id "search_result"
                    // "results" is the json response from the server
                        console.log(results);
                        $results_holder.empty();
                        $.each(results.streamers, function(i, streamer){
                            var url = results.streamer_url;
                            url = url.replace("0", streamer.pk);
                            $results_holder.append("<li><a href=\""+ url + "\">" + streamer.user__username + "</a><span class='type'>streamer</span></li>");
                        });
                        $.each(results.lobbies, function(i, lobby){
                            var url = results.lobby_url;
                            url = url.replace("0", lobby.pk);
                            $results_holder.append("<li><a href=\"" + url + "\">" + lobby.lobbyname + "</a><span class='type'>lobby</span></li>");
                        });
                        $.each(results.streams, function(i, stream){
                            $results_holder.append("<li>" + stream.title + "<span class='type'>stream</span></li>");
                        });
                    }
	  			});
		  	});
  		});
  	</script>
{% endblock content %}